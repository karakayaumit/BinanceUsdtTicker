<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <script src="lightweight-charts.standalone.production.js"></script>
</head>
<body style="margin:0">
<div id="tvchart" style="width:100%;height:100vh;position:relative;"></div>
<script>
const params = new URLSearchParams(location.search);
const symbol = (params.get('symbol') || 'BTCUSDT').toUpperCase();
const interval = params.get('interval') || '5m';
const BINANCE_REST = 'https://api.binance.com/api/v3/klines';
const BINANCE_WS = 'wss://stream.binance.com:9443/ws';

const chart = LightweightCharts.createChart(document.getElementById('tvchart'), {
  width: window.innerWidth,
  height: window.innerHeight,
  layout: {
    backgroundColor: '#ffffff',
    textColor: '#000'
  },
  grid: {
    vertLines: { color: '#e1e1e1' },
    horzLines: { color: '#e1e1e1' }
  },
  rightPriceScale: {
    visible: true
  },
  timeScale: {
    timeVisible: true,
    secondsVisible: false
  }
});
const series = chart.addCandlestickSeries();
let priceLine;

async function load() {
  const url = `${BINANCE_REST}?symbol=${symbol}&interval=${interval}&limit=500`;
  const res = await fetch(url);
  const json = await res.json();
  const bars = json.map(k => ({
    time: Math.floor(k[0] / 1000),
    open: +k[1],
    high: +k[2],
    low: +k[3],
    close: +k[4]
  }));
  series.setData(bars);
  priceLine = series.createPriceLine({
    price: bars[bars.length - 1].close,
    color: '#2962FF',
    lineWidth: 1,
    lineStyle: LightweightCharts.LineStyle.Dashed,
    axisLabelVisible: true
  });
}
load();

const ws = new WebSocket(`${BINANCE_WS}/${symbol.toLowerCase()}@kline_${interval}`);
ws.onmessage = ev => {
  const k = JSON.parse(ev.data).k;
  series.update({
    time: Math.floor(k.t / 1000),
    open: +k.o,
    high: +k.h,
    low: +k.l,
    close: +k.c
  });
  const price = +k.c;
  if (priceLine) {
    priceLine.applyOptions({ price });
  } else {
    priceLine = series.createPriceLine({
      price,
      color: '#2962FF',
      lineWidth: 1,
      lineStyle: LightweightCharts.LineStyle.Dashed,
      axisLabelVisible: true
    });
  }
};

window.addEventListener('resize', () => {
  chart.applyOptions({ width: window.innerWidth, height: window.innerHeight });
});
</script>
</body>
</html>

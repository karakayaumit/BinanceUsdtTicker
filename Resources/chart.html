<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <script type="text/javascript" src="charting_library/charting_library.js"></script>
</head>
<body style="margin:0">
<div id="tvchart" style="width:100%;height:100vh;"></div>
<script type="text/javascript">
const params = new URLSearchParams(location.search);
const symbol = (params.get('symbol') || 'BTCUSDT').toUpperCase();
const interval = params.get('interval') || '1m';
const tvIntervalMap = { '1m':'1','5m':'5','15m':'15','1h':'60','4h':'240','1d':'1D' };
const BINANCE_REST = 'https://api.binance.com/api/v3/klines';
const BINANCE_WS = 'wss://stream.binance.com:9443/ws';

const dataFeed = {
  onReady: cb => setTimeout(() => cb({
      supports_search: false,
      supported_resolutions: ['1','5','15','60','240','1D']
  }), 0),
  resolveSymbol: (symbol, onResolve, onError) => {
      onResolve({
        name: symbol,
        ticker: symbol,
        minmov: 1,
        pricescale: 100,
        has_intraday: true,
        supported_resolutions: ['1','5','15','60','240','1D']
      });
  },
  getBars: async (symbolInfo, resolution, period, onHistory, onError) => {
    try {
      const map = { '1':'1m','5':'5m','15':'15m','60':'1h','240':'4h','1D':'1d' };
      const url = `${BINANCE_REST}?symbol=${symbolInfo.ticker}&interval=${map[resolution]}&limit=500`;
      const res = await fetch(url);
      const json = await res.json();
      const bars = json.map(k => ({
        time: k[0]/1000,
        open: +k[1],
        high: +k[2],
        low: +k[3],
        close: +k[4],
        volume: +k[5]
      }));
      onHistory(bars, { noData: bars.length === 0 });
    } catch(err) { onError(err); }
  },
  subscribeBars: (symbolInfo, resolution, onRealtime, subscriberUID, onResetCacheNeeded) => {
    const map = { '1':'1m','5':'5m','15':'15m','60':'1h','240':'4h','1D':'1d' };
    const stream = `${symbolInfo.ticker.toLowerCase()}@kline_${map[resolution]}`;
    const ws = new WebSocket(`${BINANCE_WS}/${stream}`);
    ws.onmessage = ev => {
      const k = JSON.parse(ev.data).k;
      onRealtime({
        time: Math.floor(k.t/1000),
        open: +k.o,
        high: +k.h,
        low: +k.l,
        close: +k.c,
        volume: +k.v
      });
    };
    dataFeed._ws = ws;
  },
  unsubscribeBars: () => { dataFeed._ws && dataFeed._ws.close(); }
};

new TradingView.widget({
  symbol: symbol,
  interval: tvIntervalMap[interval] || '5',
  container: 'tvchart',
  datafeed: dataFeed,
  library_path: 'charting_library/',
  locale: 'en'
});
</script>
</body>
</html>
